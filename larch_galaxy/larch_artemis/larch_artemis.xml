<tool id="larch_artemis" name="Larch Artemis" version="@TOOL_VERSION@+galaxy@WRAPPER_VERSION@" python_template_version="3.5" profile="22.05" license="MIT">
    <description>generate Artemis projects from XAFS data</description>
    <macros>
        <!-- version of underlying tool (PEP 440) -->
        <token name="@TOOL_VERSION@">0.9.66</token>
        <!-- version of this tool wrapper (integer) -->
        <token name="@WRAPPER_VERSION@">0</token>
        <!-- citation should be updated with every underlying tool version -->
        <!-- typical fields to update are version, month, year, and doi -->
        <token name="@TOOL_CITATION@">10.1088/1742-6596/430/1/012007</token>
    </macros>
    <creator>
        <person givenName="Patrick" familyName="Austin" url="https://github.com/patrick-austin"/>
        <organization url="https://muon-spectroscopy-computational-project.github.io/index.html" name="The Muon Spectroscopy Computational Project"/>
    </creator>
    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">xraylarch</requirement>
        <requirement type="package" version="3.5.2">matplotlib</requirement>
        <!-- xraydb 4.5.0 is compatible with sqlalchemy 2, but is not yet available on condaforge so pin it -->
        <requirement type="package" version="4.4.7">xraydb</requirement>
        <requirement type="package" version="1.4.46">sqlalchemy</requirement>
        <requirement type="package" version="2023.3.23">pymatgen</requirement>
    </requirements>
    <required_files>
        <include type="glob" path="lib/*.py"/>
        <include type="literal" path="larch_artemis.py"/>
    </required_files>
    <command detect_errors="exit_code"><![CDATA[
        structure_files_renamed=''
        #for $structure_file in $structure_files
        && ln -s '$structure_file' '$structure_file.name'
        && structure_files_renamed+='$structure_file.name,'
        && echo \$structure_files_renamed
        #end for
        && python '${__tool_directory__}/larch_artemis.py' '$prj_file' \$structure_files_renamed '$gds_file' '$sp_file' '$inputs'
    ]]></command>
    <configfiles>
        <inputs name="inputs"/>
    </configfiles>
    <inputs>
        <param name="prj_file" type="data" format="binary" label="Athena project file" help="Normalised X-ray Absorption Fine Structure (XAFS) data, in Athena project format."/>
        <!-- TODO sort out inp file types -->
        <param name="structure_files" type="data" format="cif, txt" multiple="true" label="Crystal structure file" help="One or more crystal structure files to be used for fitting, in CIF format."/>
        <param name="gds_file" type="data" format="csv" label="GDS parameters file" help="File defining the fitting parameters as a `guess` (to be varied in the fit), `def` (defined by an expression evaluated throughout fitting) or `set` (evaluated at the start of fitting, then left unchanged)."/>
        <param name="sp_file" type="data" format="csv" label="SP parameters file" help="File defining the scattering paths."/>
        <!-- TODO help text and sensible types, limits etc. -->
        <section name="fit_vars" title="Fitting Variables">
            <param argument="fitspace" type="text" value="r"/>
            <param argument="kmin" type="integer" value="3"/>
            <param argument="kmax" type="integer" value="14"/>
            <param argument="kw" type="integer" value="2"/>
            <param argument="dk" type="integer" value="1"/>
            <param argument="window" type="text" value="hanning"/>
            <param argument="rmin" type="float" value="1.4"/>
            <param argument="rmax" type="float" value="3.0"/>
        </section>
        <param name="plot_graph" type="boolean" label="Plot graph" help="Whether to plot the data."/>
    </inputs>
    <outputs>
        <!-- TODO don't know how to actually generate this as an output... -->
        <!-- <data name="artemis_project_file" format="binary" from_work_dir="out.fpj" label="Artemis project of ${prj_file.name}"/> -->
        <data name="fit_report" format="txt" from_work_dir="fit_report.txt" label="Fit report of ${prj_file.name}"/>
        <data name="norm" format="png" from_work_dir="norm.png" label="Normalised plot of ${prj_file.name}">
            <filter>plot_graph</filter>
        </data>
        <data name="rmr" format="png" from_work_dir="rmr.png" label="RMR plot of ${prj_file.name}">
            <filter>plot_graph</filter>
        </data>
        <data name="chikr" format="png" from_work_dir="chikr.png" label="ChiKR plot of ${prj_file.name}">
            <filter>plot_graph</filter>
        </data>
    </outputs>
    <tests>
        <test expect_num_outputs="1">
            <param name="prj_file" value="test.prj"/>
            <param name="structure_files" value="test.inp"/>
            <param name="gds_file" value="gds.csv"/>
            <param name="sp_file" value="sp.csv"/>
            <output name="fit_report" file="fit_report.txt" compare="re_match"/>
        </test>
        <test expect_num_outputs="4">
            <param name="prj_file" value="test.prj"/>
            <param name="structure_files" value="test.inp"/>
            <param name="gds_file" value="gds.csv"/>
            <param name="sp_file" value="sp.csv"/>
            <param name="plot_graph" value="true"/>
            <output name="fit_report" file="fit_report.txt" compare="re_match"/>
            <output name="norm">
                <assert_contents>
                    <has_size value="43900" delta="100"/>
                </assert_contents>
            </output>
            <output name="rmr">
                <assert_contents>
                    <has_size value="53500" delta="100"/>
                </assert_contents>
            </output>
            <output name="chikr">
                <assert_contents>
                    <has_size value="76000" delta="100"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
        Using Larch, perform fitting on an Athena project file, originally from the input X-ray Absorption Fine Structure (XAFS) data file.

        Optionally, plot the xÎ¼ data along with RMR and ChiKR plots for visual inspection of the fit. 
    ]]></help>
    <citations>
        <citation type="doi">@TOOL_CITATION@</citation>
        <citation type="doi">10.1107/S0909049505012719</citation>
    </citations>
</tool>